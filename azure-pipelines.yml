jobs:
  - job: Lint
    pool:
      vmImage: 'Ubuntu 16.04'

    steps:
    - task: UsePythonVersion@0
      displayName: Setup Python
      inputs:
        versionSpec: '3.7'

    - template: azure-steps/install_deps.yml

    - script: |
        pipenv run make check
        pipenv run make pylint
      displayName: Lint

  - job: Docs
    pool:
      vmImage: 'Ubuntu 16.04'

    steps:
    - task: UsePythonVersion@0
      displayName: Setup Python
      inputs:
        versionSpec: '3.7'

    - template: azure-steps/install_deps.yml

    - script: |
        pipenv run make doccheck
      displayName: Build Docs

  - job: Linux
    pool:
      vmImage: 'Ubuntu 16.04'
    strategy:
      maxParallel: 4
      matrix:
        python27:
          python.version: '2.7'
        python34:
          python.version: '3.4'
        python35:
          python.version: '3.5'
        python36:
          python.version: '3.6'
        python37:
          python.version: '3.7'

    steps:
    - task: UsePythonVersion@0
      displayName: Setup Python$(python.version)
      inputs:
        versionSpec: '$(python.version)'

    - template: azure-steps/install_deps.yml

    - script: 'pipenv run make coverage'
      displayName: Run Tests with Coverage

    - task: PublishTestResults@2
      displayName: Publish Test Results
      inputs:
        testResultsFiles: 'test-results.xml'
        mergeTestResults: true
        testRunTitle: '$(agent.os) Python $(python.version)'
        platform: Linux
      condition: succeededOrFailed()

    - task: PublishCodeCoverageResults@1
      displayName: Publish Code Coverage Results
      inputs:
        codeCoverageTool: 'cobertura'
        summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
        reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
        failIfCoverageEmpty: true
    
    - script: 'pipenv run python -m codecov --token $(CODECOV_TOKEN) --required --name "$(agent.os)-$(python.version)" --build "$(Build.DefinitionName)" --env OS=$(agent.os) python=$(python.version)'
      displayName: Upload to codecov.io
      condition: succeeded()

